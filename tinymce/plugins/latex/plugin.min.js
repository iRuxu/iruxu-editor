tinymce.PluginManager.add("latex", function (editor, url) {
    const openDialog = () => {
        const root = window.RX_TINYMCE_ROOT || '';
        return editor.windowManager.openUrl({
            title: "数学公式",
            url: `${root}/plugins/latex/latex-dialog/index.html?root=${encodeURIComponent(root)}`,
            width: 1200,
            height: 800,
        });
    };

    // 注册一个工具栏按钮名称
    editor.ui.registry.addButton("latex", {
        // icon : 'latex',
        text: "Σ",
        tooltip: "插入Latex",
        onAction: function () {
            openDialog();
        },
    });

    window.addEventListener("message", (e) => {
        if (e.data?.source !== "tinymce-latex") return;

        if (e.data.type === "insert") {
            editor.insertContent(`<pre class="e-latex-area w-latex">${e.data.payload.latex}</pre>`);
            editor.windowManager.close();
        }

        if (e.data.type === "close") {
            editor.windowManager.close();
        }
    });

    // 注册一个菜单项名称 menu/menubar
    // editor.ui.registry.addMenuItem("latex", {
    //     text: "Example菜单名",
    //     onAction: function () {
    //         openDialog();
    //     },
    // });

    return {
        getMetadata: function () {
            return {
                //插件名和链接会显示在“帮助”→“插件”→“已安装的插件”中
                name: "latex", //插件名称
                url: "https://github.com/iRuxu", //作者网址
            };
        },
    };
});
